
## Evaluation

_"If it compiles, it is good; if it boots up, it is perfect."_ -- Linus Torvalds

* Evaluation should document that the goals have been achieved
	* Functional requirements (i.e., testing)
	* Non-functional requirements (e.g., performance)
* Definition of the evaluation strategy
	* Qualitative-/quantitative evaluation
	* Software testing
		* white-box/black-box
		* testing levels
			*unit testing, integrationg testing, system testing, acceptance testing
* summarised output from the evaluation
	*output should be explained
	* provisional conclusions should be presented
	

![XKCD Correlation][correlation]

[correlation]:figures/correlation.png "Correlation"


### Software testing

The implementation have been tested using a combination of white box and black box testing. 
<TODO bedre intro>

#### White box testing 

We have used JUnit tests to implement the white box testing. The relative simple Event classes, EventList and KeyList have been tested in this way. 

#### Black box testing

The more complex classes DecisionMatrix and Correlation are tested using black box testing, and are based on data generated by the simulator. The testing setup for the black box test black box test, consists of 6 sensors (1,2,3,7,8,9) and 3 switches (4,5,6). A simulated takes various paths to generate a representative sample of event patterns.

| Index | Description | Event sequence |
|:-----:|:------------|:--------------:|
| 1     | Path _A_, switch 4 on, sensor 9 | [1, 1&2, 2&3, 3, 4 on, 9] |
| 2     | Path _B_ then turns switch 5 off | [1&2, 5 off] |
| 3     | Path _B_ without using any switches | [1&2] |
| 4     | Path _C_, switch 6 on, sensor 7 | [2&3, 6 on, 7] |
| 5     | Path _C_ without using any switches | [2&3] |
| 6     | Path _C_, switch 6 on, sensor 8 | [2&3, 6 on, 8] | 
[Event patterns used for black box testing][bbox data]

Based on these simple event pattens, an accurate expected output can be determined for both the DecisionMatrix and Correlation. The expected output for the DecisionMatrix is based on the number of times each event pattern has been seen, and the number of times they have led to a switch event. Only patterns which leads to switch events are listed.

| Description | Sensor pattern | Switch | State | Probability |
| without zone events ||||
| Path _A_ | [1, 1, 2, 2, 3] | 4 | on | 1 |
| Path _B_ | [1, 2] | 5 | off | 0.5 |
| Path _C_ | [2, 3] | 6 | on | 0.67 |
| with zone events ||||
| Path _A_ | [1, 1&2, 2&3] | 4 | on | 1 |
| Path _B_ | [1, 2] | 5 | off | 0.5 |
| Path _C_ | [2, 3] | 6 | on | 0.67 |
[DecisionMatrix's expected output][matrix expected]

Testing of the DecisionMatrix releaved what at first looked like an error. The probability for Path _C_ without zones had a probability of 100%, but with zones had the expected probability of 67%. Investigation revealed the cause was test case 5, where sensor 2 and 3 was triggered in the opposite order as test case 4 and 6. So while this error at first glace looked like a bug, is actually a feature, and one of the very reasons zone events were implemented. All other probabilities in the DecisionMatrix was as expected.

For the correlation table, the output is determined only by test cases where switches are turned on (1, 4 and 6). The expected output is:

| switches | sensors |||
|   | 7 | 8 | 9 |
|:-:|:-:|:-:|:-:|
| 4 | 0 | 0 | 1 |
| 6 | 0.5 | 0.5 | 0 |
[Correlation table's expected output][corr expected]

The correlation table produced the expected results.
<TODO correlation doesn't work yet>

![Overview of the simple setup used for black box testing the DecisionMatrix and Correlation][zonetest]

[zonetest]:figures/zone2.png "Black box testing setup" 

### Passive learning data

This section is going to evaluate how much the system have been able to learn, based on the data collected from the passive learning stage. In total 45.628 sensor events and 346 switch events was recorded. This is a very high sensor event to switch event ration, slight above 130 sensor events per switch event.

Of the 346 switch events, 194 was On events and 152 was Off events. If all switch event in a continuous period was recorded, the discrepency between on and off events would be atmost the number of actual switches. This could be due to lost Z-Wave messages, users forgetting to pressing the placebo switches. The system isn't dependant on the correct ordering of switch events, i.e. that On events are eventually always followed by an Off event, and vice versa. 

The discrepency between On and Off events, are an indicator that data have been lost, the system should still be able to learn based on the user data. The system will obviously not be able to learn based on the lost switch events. Assuming only switch events are lost, the missing switch events will also impact the system by having an increased sensor to switch event ratio, lowering the probabilities in the decision matrix.

The Correlation table isn't based on the entire data set of sensor events, but merely the interval after each On event. Therefor the sensor to switch event ratio for the Correlation table, isn't necesarily affected by missing switch events. 

#### Decision matrix

In order to better evaluate the Decision Matrix, it have been run on the training several times, with different pattern lengths, with and without zone detection. The evaluation will look upon the advantages and disadvantages the different configurations, and 

| Settings                      || Unique observed patterns                     |||
| Pattern length | Zones enabled | Movement patterns | On patterns | Off patterns |
|:--------------:|:-------------:|:-----------------:|:-----------:|:------------:|
| 2              | No            | 111               | 90          | 78           |
| 2              | Yes           | 1.168             | 149         | 121          |
| 3              | No            | 910               | 142         | 116          |
| 3              | Yes           | 3.870             | 227         | 173          |
| 7              | Yes           | 12.967            | 322         | 215          |
[Statistics about the Decision matrix][dtable metadata]

With zones enabled, the system looks at the event patterns leading up to each switch event, with and without zone detection. Detecting up to two switch patterns for every switch event, in some configurations there are more total switch patterns detected than actual switch events.

<TODO vi skal nok lige snakke lidt om hvad vi kan og vil konkludere baseret paa decision matrix>
<TODO snippets from different configurations>

#### Correlation

In this section we are going to evaluate how well correlation, based on the generated user data, matches to the actual setup. Is the system able to get accurate estimates of which sensors and switches are in the same room. We are also going to evaluate how well the correlation based timeout would work, with or without correlation corrections. Prior to looking at the actual data, we want to state some resoanable goals we want the system to achieve for the correlation probabilities:

1. A sensor should have the highest correlation to the switch in the room it is in.
2. Some correlation threshold should exist, so that sensors and switches in the same room are above the threshold, and those not in the same room are below the threshold.

| Switches             || Sensors                                                                                       ||||||||||
|  	 |                  | 20      | 21       | 22   | 23       | 24       | 25       | 26       | 27       | 28       | 29       |
|                      || Hallway           || Living room              ||| Kitchen            || Bedroom            || WC       |
|---:|:-----------------|:-------:|:--------:|:----:|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| 4  |	Hallway         | **0.4** | **0.67** | 0    | 0.2      | 0.13     | 0.07     | 0        | 0        | 0.07     | 0        |
| 13 |	Living room     | *0.35*  | *0.23*   | 0.12 | *0.27*   | **0.42** | 0.04     | 0.04     | 0.08     | 0.08     | 0        |
| 17 |	Kitchen         | *0.22*  | *0.28*   | 0    | 0.03     | 0.17     | *0.39*   | **0.58** | 0.14     | 0.03     | 0.03     |
| 18 |	Bedroom         | 0.1     | 0.13     | 0    | 0        | 0.03     | 0.03     | 0        | **0.57** | **0.6**  | 0.03     |
| 19 |	WC              | *0.29*  | *0.29*   | 0.06	| 0.09     | 0.08     | 0.06     | 0        | 0.07     | 0.03     | **0.75** |
[Correlation table, based on statistical data. > 40% in bold, 40-20% in italic.][ctable data] 

The [correlation table][ctable data] is based on collected data from the testing environment. The first criteria holds, that all sensors have the highest correlation with the switch in the room they are in. 
The send criteria does not hold for all correlations. Most correlation probability for sensors and switches in the same room are above 40%. All correlations for switches and sensors not in the same room are below 40%. But three sensors have correlations lower than 40% to the switch in the room they are in, and one of them as low as 12%. In the living room, two sensors not only have correlations below 40%, but correlations below those of sensors in the adjecent hallway. 

As can be seen in [the overview of the appartment](#Hellebaekgade), the sensors 22 and 25 are located in the far end of the rooms from the switch and doorway. Since the calculated correlation probabilities are based on the time interval just after the light is turned on, it makes sense that these sensor, being relatively far away from the switches ends up with a lower correlation. 

[Hellebaekgade]: figures/hellebaekgade3.png "Hellebaekgade image"

Sensor 23 is positioned to monitor the sofa in front of the TV, and the data suggest that it only detect the user if he go to the sofa immediately after he enters the room. So not all sensors neccesarily trigger in a room, depending on what the user decides to do in the room. 

So in this case, the correlation still gives an excelent estimate of which switches and sensors are in the same room, by looking switch each sensor has the highest correlation probability too. 

One thing to note is, these are the probabilities based solely on the statistical data, and that correlation corretions would be added onto this schema. So it is not a perfect reflect of which sensors are in the same room each switch, on it is own. But it does gives a good approximation.

#### Correlation based timeout

The implemented functionality of the correlation table, is to determine the timeout for each switch. How well is the correlation table able to keep the light on where it's needed. Different areas should have different timeouts, but most important is for the system to have long timeouts in areas where the user is likely to be still for extended periods of time, while still wanting the light to remain on. The most obvious area would be the sofa, where a user is likely to be for hours. Based on the statistical correlation alone, the system would have one of the lowest timeouts when the user is detected in the sofa, where it should be the highest. However in the evolution stage the correlation correction comes into effect. Every time the system incorrectly turns off the light, and the user turns it on again, the system is punished and increases the correlation, and by extension the timeout. As a result of this, the system will gradually increase the timeout until it no longer turns off the light, while the user is watching TV.


